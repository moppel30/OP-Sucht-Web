<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<title>OPSUCHT Markt & Auktionshaus</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
:root { --accent-color1: #ff9800; --accent-color2: #f57c00; }
body { font-family: Arial, sans-serif; background: linear-gradient(135deg,#2d2d2d 0%,#1a1a1a 100%); color:#e0e0e0; padding:25px; min-height:100vh; }
h1 { color:var(--accent-color1); text-align:center; font-size:2.5em; margin-bottom:15px; text-shadow:2px 2px 4px rgba(0,0,0,0.5);}
button { padding:10px 20px; font-size:16px; cursor:pointer; background:linear-gradient(135deg,var(--accent-color2),#00000044); border:none; border-radius:50px; color:white; font-weight:bold; box-shadow:0 4px 15px var(--accent-color2); transition:0.3s; margin:5px;}
button:hover { transform:translateY(-2px); box-shadow:0 6px 20px var(--accent-color2); }
input[type="text"] { width:100%; padding:14px; font-size:18px; margin-bottom:30px; border-radius:8px; border:2px solid var(--accent-color1); background:#2a2a2a; color:#fff; outline:none; }
.grid { display:grid; grid-template-columns:repeat(auto-fill,minmax(220px,1fr)); gap:20px; }
.card { background:#2a2a2a; border-radius:12px; padding:15px; text-align:center; box-shadow:0 4px 12px rgba(0,0,0,0.4);}
.card img { width:64px; height:64px; cursor:pointer;}
.card h3 { color:var(--accent-color1); font-size:15px; }
.buy { color:#4caf50; }
.sell { color:#f44336; }

/* MODAL */
.modal { display:none; position:fixed; inset:0; background:rgba(0,0,0,0.75); justify-content:center; align-items:center; z-index:999; }
.modal-content { background:#222; border-radius:12px; width:90%; max-width:800px; padding:20px; position:relative; }
.close { position:absolute; right:15px; top:10px; cursor:pointer; color:var(--accent-color1); font-size:22px; }
.chart-buttons { text-align:right; margin-bottom:10px; }
.chart-buttons button { margin:5px; padding:8px 14px; border-radius:20px; border:none; background:var(--accent-color1); font-weight:bold; cursor:pointer;}
canvas { height:400px !important; }

/* Tabs */
#tabs { text-align:center; margin-bottom:25px; }
.section { display:none; }
.section.active { display:block; }
</style>
</head>
<body>

<h1>üõí OPSUCHT Markt & Auktionshaus</h1>

<div id="tabs">
    <button onclick="showSection('market')">Markt</button>
    <button onclick="showSection('auctions')">Auktionen</button>
</div>

<!-- MARKT -->
<div id="market" class="section">
    <input type="text" id="searchMarket" placeholder="üîç Item oder Kategorie suchen ‚Ä¶" oninput="renderMarket()">
    <div id="marketContainer"></div>
</div>

<!-- AUKTIONEN -->
<div style="text-align:right; margin-bottom:10px;">
    <button id="auctionSortBtn" onclick="toggleAuctionSort()">Sortieren nach: Bald endend</button>
</div>
<div id="auctions" class="section">
    <input type="text" id="searchAuctions" placeholder="üîç Item oder Kategorie suchen ‚Ä¶" oninput="renderAuctions()">
    <div id="auctionContainer"></div>
</div>

<!-- MODAL -->
<div id="chartModal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="closeModal()">‚úñ</span>
        <h2 id="modalTitle"></h2>
        <div class="chart-buttons">
            <button onclick="loadHistory('HOURLY')">Stunde</button>
            <button onclick="loadHistory('DAILY')">Tag</button>
            <button onclick="loadHistory('WEEKLY')">Woche</button>
            <button onclick="loadHistory('MONTHLY')">Monat</button>
        </div>
        <canvas id="priceChart"></canvas>
    </div>
</div>

<script>
let auctionSortMode = "END"; // "END" = Bald endend, "NEW" = Neueste zuerst
let marketPrices = {}, marketItems = [], auctionsData = [];
let currentItem = null, chart=null;
const uuidCache = {};


function toggleAuctionSort() {
    auctionSortMode = auctionSortMode === "END" ? "NEW" : "END";
    const btn = document.getElementById("auctionSortBtn");
    btn.textContent = "Sortieren nach: " + (auctionSortMode === "END" ? "Bald endend" : "Neueste");
    renderAuctions(); // Auktionen neu rendern nach der neuen Sortierung
}



function closeModal() {
    document.getElementById("chartModal").style.display = "none";
    currentItem = null;        // Reset current item
    if (chart) {
        chart.destroy();       // Chart l√∂schen
        chart = null;
    }
}


// Tabs
function showSection(id){
    document.querySelectorAll('.section').forEach(sec=>sec.classList.remove('active'));
    document.getElementById(id).classList.add('active');
}

// UUID ‚Üí Username
async function uuidToUsername(uuid) {
    if(!uuid) return "-";
    if(uuidCache[uuid]) return uuidCache[uuid];
    try{
        const res = await fetch(`https://playerdb.co/api/player/minecraft/${uuid}`);
        const data = await res.json();
        if(data.success){uuidCache[uuid]=data.data.player.username; return uuidCache[uuid];}
        uuidCache[uuid]="privat"; return "privat";
    }catch{uuidCache[uuid]="privat"; return "privat";}
}

// Markt laden
async function loadMarket(){
    marketPrices=await (await fetch("https://api.opsucht.net/market/prices")).json();
    marketItems=await (await fetch("https://api.opsucht.net/market/items")).json();
    renderMarket();
}

// Markt rendern
function renderMarket() {
    const container = document.getElementById("marketContainer");
    const search = document.getElementById("searchMarket").value.toLowerCase();
    container.innerHTML = "";

    for (const category in marketPrices) {
        const itemsInCategory = Object.keys(marketPrices[category])
            .filter(material => 
                material.toLowerCase().includes(search) || category.toLowerCase().includes(search)
            );

        if (itemsInCategory.length === 0) continue; // keine Treffer in dieser Kategorie

        const h2 = document.createElement("h2");
        h2.textContent = category;
        container.appendChild(h2);

        const grid = document.createElement("div");
        grid.className = "grid";

        for (const material of itemsInCategory) {
            const item = marketItems.find(i => i.material === material);
            if (!item) continue;

            const orders = marketPrices[category][material];
            const buy = orders.find(o => o.orderSide === "BUY") || {};
            const sell = orders.find(o => o.orderSide === "SELL") || {};

            const card = document.createElement("div");
            card.className = "card";
            card.innerHTML = `
                <img src="${item.icon}" onclick="openChart('${material}')">
                <h3>${material}</h3>
                <div class="buy">BUY: ${buy.price ?? "-"} (${buy.activeOrders ?? 0})</div>
                <div class="sell">SELL: ${sell.price ?? "-"} (${sell.activeOrders ?? 0})</div>
            `;
            grid.appendChild(card);
        }

        container.appendChild(grid);
    }
}

// Auktionen laden
async function loadAuctions(){
    auctionsData=await (await fetch("https://api.opsucht.net/auctions/active")).json();
    renderAuctions();
}

// Auktionen rendern
async function renderAuctions() {
    const container = document.getElementById("auctionContainer");
    const search = document.getElementById("searchAuctions").value.toLowerCase();
    container.innerHTML = "";

    const categories = {};
    auctionsData.forEach(a => {
        const cat = a.item?.category ?? "Auktionen";
        if (!categories[cat]) categories[cat] = [];
        categories[cat].push(a);
    });

    for (const cat in categories) {
        // Filter nach Suchbegriff: Kategorie, technischer Name, Custom Name
        let auctionsInCategory = categories[cat].filter(a => {
            const displayName = a.item.displayName ?? "";
            const material = a.item.material ?? "";
            return (
                cat.toLowerCase().includes(search) ||
                displayName.toLowerCase().includes(search) ||
                material.toLowerCase().includes(search)
            );
        });

        if (auctionsInCategory.length === 0) continue; // keine Treffer in dieser Kategorie

        // Sortieren nach Modus
        if (auctionSortMode === "END") {
            auctionsInCategory.sort((a, b) => new Date(a.endTime) - new Date(b.endTime)); // Bald endend
        } else {
            auctionsInCategory.sort((a, b) => new Date(b.startTime) - new Date(a.startTime)); // Neueste zuerst
        }

        const h2 = document.createElement("h2");
        h2.textContent = cat;
        container.appendChild(h2);

        const grid = document.createElement("div");
        grid.className = "grid";

        for (const a of auctionsInCategory) {
            const displayName = a.item.displayName ?? a.item.material;
            const card = document.createElement("div");
            card.className = "card";
            card.innerHTML = `
                <img src="${a.item.icon}" 
                     onclick='openAuctionChart(${JSON.stringify(a)})' 
                     onerror="this.src='https://i.postimg.cc/LXLWtvLT/geldbeutel.png'">
                <h3>${displayName}</h3>
                <div class="buy">Start: ${a.startBid}</div>
                <div class="sell">Aktuell: ${a.currentBid ?? a.startBid}</div>
                <div class="buy">Menge: ${a.item.amount}</div>
            `;
            grid.appendChild(card);
        }

        container.appendChild(grid);
    }
}


// MODAL
function closeModal(){ document.getElementById("chartModal").style.display="none"; if(chart) chart.destroy(); }

// Markt History
async function loadHistory(period){
    if(!currentItem) return;
    const data=await (await fetch(`https://api.opsucht.net/market/history/${currentItem}`)).json();
    const history=data[period];
    const labels=history.map(h=>{
        const d=new Date(h.timestamp);
        if(period==="HOURLY") return d.getHours().toString().padStart(2,"0")+":00 Uhr";
        if(period==="DAILY") return d.toLocaleDateString("de-DE");
        if(period==="WEEKLY") return "KW "+Math.ceil((((d-new Date(d.getFullYear(),0,1))/86400000)+1)/7);
        if(period==="MONTHLY") return (d.getMonth()+1).toString().padStart(2,"0")+"."+d.getFullYear();
    });
    const pricesData=history.map(h=>h.avgPrice);
    const ctx=document.getElementById("priceChart").getContext("2d");
    if(chart) chart.destroy();
    chart=new Chart(ctx,{
        type:"line",
        data:{labels,datasets:[{data:pricesData,borderColor:"#ff9800",backgroundColor:"#ff980033",fill:true,tension:0.2}]},
        options:{responsive:true,plugins:{legend:{display:false}}}
    });
}

function openChart(material){ currentItem=material; document.getElementById("modalTitle").textContent=material; document.getElementById("chartModal").style.display="flex"; loadHistory("DAILY"); }


// Markt Chart
function openChart(material) {
    currentItem = material;
    document.getElementById("modalTitle").textContent = material;
    document.getElementById("chartModal").style.display = "flex";

    // Chart-Buttons nur f√ºr den Markt einblenden
    document.querySelector(".chart-buttons").style.display = "block";

    // Auktion-Details ausblenden, falls vorhanden
    const detailsDiv = document.getElementById("auctionDetails");
    if(detailsDiv) detailsDiv.style.display = "none";

    loadHistory("DAILY");
}


// Auktion Chart
async function openAuctionChart(auction){
    currentItem = null;
    document.getElementById("modalTitle").textContent = auction.item.displayName ?? auction.item.material;
    document.getElementById("chartModal").style.display = "flex";

    // Chart-Buttons f√ºr Auktionen ausblenden
    document.querySelector(".chart-buttons").style.display = "none";

    // Verk√§ufer, Start- und Endzeit im Modal einf√ºgen
    const seller = auction.seller ? await uuidToUsername(auction.seller) : "-";
    const startTime = new Date(auction.startTime).toLocaleString("de-DE");
    const endTime = new Date(auction.endTime).toLocaleString("de-DE");

    // Pr√ºfen, ob Details schon existieren, sonst erstellen
    let detailsDiv = document.getElementById("auctionDetails");
    if(!detailsDiv){
        detailsDiv = document.createElement("div");
        detailsDiv.id = "auctionDetails";
        detailsDiv.style.marginBottom = "15px";
        detailsDiv.style.fontSize = "14px";
        detailsDiv.style.color = "#eee";
        document.querySelector(".modal-content").insertBefore(detailsDiv, document.getElementById("priceChart"));
    }
    detailsDiv.innerHTML = `
        Verk√§ufer: ${seller}<br>
        Startzeit: ${startTime}<br>
        Endzeit: ${endTime}
    `;

    const bids = auction.bids || {};
    const sortedBids = Object.entries(bids).sort((a,b) => a[1]-b[1]);
    const playerNames = [];
    const amounts = [];
    for(const [uuid, amount] of sortedBids){
        const name = await uuidToUsername(uuid);
        playerNames.push(name);
        amounts.push(amount);
    }

    const ctx = document.getElementById("priceChart").getContext("2d");
    if(chart) chart.destroy();
    chart = new Chart(ctx, {
        type: "line",
        data: { labels: playerNames, datasets:[{data: amounts, borderColor:"#ff9800", backgroundColor:"#ff980033", fill:true, tension:0.2}] },
        options: {
            responsive:true,
            plugins:{ legend:{ display:false } },
            scales:{ y:{ beginAtZero:true, title:{display:true,text:"Gebotsbetrag"} }, x:{ title:{ display:true, text:"Spieler"} } }
        }
    });
}

// INIT
async function init(){ await loadMarket(); await loadAuctions(); showSection('market'); }
init();
</script>

</body>
</html>
