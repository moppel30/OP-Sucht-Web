<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<title>OPSUCHT Markt & Auktionshaus</title>
<style>
:root { --accent-color1: #ff9800; --accent-color2: #f57c00; }
body { font-family: Arial, sans-serif; background: linear-gradient(135deg, #2d2d2d 0%, #1a1a1a 100%); color: #e0e0e0; padding: 25px; min-height: 100vh; }
h1 { color: var(--accent-color1); text-align: center; font-size: 2.5em; margin-bottom: 25px; text-shadow: 2px 2px 4px rgba(0,0,0,0.5); }
h2 { margin-top: 40px; color: var(--accent-color1); border-bottom: 3px solid var(--accent-color1); padding-bottom: 8px; font-size: 1.8em; }
button { padding: 12px 25px; font-size: 16px; cursor: pointer; background: linear-gradient(135deg, var(--accent-color2), #00000044); border: none; border-radius: 50px; color: white; font-weight: bold; box-shadow: 0 4px 15px var(--accent-color2); transition: 0.3s; margin: 5px; }
button:hover { transform: translateY(-2px); box-shadow: 0 6px 20px var(--accent-color2); }
input[type="text"] { width: 100%; padding: 14px; font-size: 18px; margin-bottom: 30px; border-radius: 8px; border: 2px solid var(--accent-color1); background: #2a2a2a; color: #fff; outline: none; }
table { width: 100%; border-collapse: collapse; margin-top: 15px; background: #3a3a3a; border-radius: 10px; overflow: hidden; box-shadow: 0 4px 15px rgba(0,0,0,0.3); }
th, td { border: 1px solid #555; padding: 12px; text-align: center; }
th { background: #2a2a2a; color: var(--accent-color1); font-size: 16px; cursor:pointer; }
tr:nth-child(even) { background: #333; }
tr:hover { background: #404040; }
.buy { color: #4caf50; font-weight: bold; }
.sell { color: #f44336; font-weight: bold; }
.status { margin: 15px 0; font-style: italic; text-align: center; font-size: 18px; color: var(--accent-color1); padding: 15px; background: rgba(255, 152, 0, 0.1); border-radius: 8px; border: 2px solid var(--accent-color1); }
.chart-container { width: 100%; height: 400px; max-height: 400px; margin-top: 10px; }
.chart-buttons { text-align: center; margin-bottom: 5px; }
#accentPickerContainer { text-align: center; margin-bottom: 20px; }
#accentPreview1, #accentPreview2 { display:inline-block; width:36px; height:36px; border-radius:50%; border: 2px solid; vertical-align:middle; box-shadow: 0 4px 10px rgba(0,0,0,0.3); cursor:pointer; transition: transform 0.2s; margin-left:10px; }
#accentPreview1 { background-color: var(--accent-color1); border-color: var(--accent-color1); }
#accentPreview2 { background-color: var(--accent-color2); border-color: var(--accent-color2); }
</style>
</head>
<body>

<h1>üéÆ OPSUCHT Markt & Auktionshaus</h1>

<div id="accentPickerContainer">
    <button onclick="loadMarket()">üìä Alle Items laden</button>
    <button onclick="loadAuctions()">üõí Auktionen laden</button>
    <button id="sortButton" onclick="toggleSort()" style="display:none;">Sortieren nach: Bald endend</button>
    <label for="accentPicker1"><div id="accentPreview1"></div></label>
    <input type="color" id="accentPicker1" value="#ff9800" style="display:none;">
    <label for="accentPicker2"><div id="accentPreview2"></div></label>
    <input type="color" id="accentPicker2" value="#f57c00" style="display:none;">
</div>

<input type="text" id="searchInput" placeholder="üîç Item filtern" oninput="filterItems()">

<div id="status" class="status"></div>
<div id="content"></div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
let auctionsData = [];
let marketData = [];
let sortByEnd = true; // true: Bald endend, false: Neuste
let currentView = 'market'; // 'market' oder 'auctions'
let charts = {};
const uuidCache = {};

// Farbauswahl
const accentPicker1 = document.getElementById('accentPicker1');
const accentPicker2 = document.getElementById('accentPicker2');
const accentPreview1 = document.getElementById('accentPreview1');
const accentPreview2 = document.getElementById('accentPreview2');

accentPicker1.addEventListener('input', e => {
    const color = e.target.value;
    document.documentElement.style.setProperty('--accent-color1', color);
    accentPreview1.style.backgroundColor = color;
    accentPreview1.style.borderColor = color;
    // Diagramme & Status
    for (const key in charts) {
        charts[key].data.datasets[0].borderColor = color;
        charts[key].data.datasets[0].backgroundColor = color + '33';
        charts[key].update();
    }
    document.getElementById('status').style.backgroundColor = color + '33';
});

accentPicker2.addEventListener('input', e => {
    const color = e.target.value;
    document.documentElement.style.setProperty('--accent-color2', color);
    accentPreview2.style.backgroundColor = color;
    accentPreview2.style.borderColor = color;
    // Buttons aktualisieren
    document.querySelectorAll('button').forEach(btn => {
        btn.style.background = `linear-gradient(135deg, ${color}, #00000044)`;
        btn.style.boxShadow = `0 4px 15px ${color}`;
    });
});

accentPreview1.addEventListener('click', () => accentPicker1.click());
accentPreview2.addEventListener('click', () => accentPicker2.click());

// UUID ‚Üí Username
async function uuidToUsername(uuid) {
    if (!uuid) return "-";
    if (uuidCache[uuid]) return uuidCache[uuid];
    try {
        const res = await fetch(`https://playerdb.co/api/player/minecraft/${uuid}`);
        const data = await res.json();
        if (data.success) { uuidCache[uuid] = data.data.player.username; return uuidCache[uuid]; }
        uuidCache[uuid] = "Error"; return "Error";
    } catch { uuidCache[uuid] = "Error"; return "Error"; }
}

// MARKT
async function loadMarket() {
    currentView = 'market';
    document.getElementById('sortButton').style.display = 'none';
    const status = document.getElementById("status");
    const content = document.getElementById("content");
    status.textContent = "‚è≥ Lade Marktdaten...";
    content.innerHTML = "";
    try {
        const response = await fetch("https://api.opsucht.net/market/prices");
        const data = await response.json();
        marketData = data;

        for (const category in data) {
            const h2 = document.createElement("h2");
            h2.textContent = category;
            content.appendChild(h2);

            const table = document.createElement("table");
            table.innerHTML = `
                <thead>
                    <tr>
                        <th>Item</th>
                        <th>BUY Preis</th>
                        <th>BUY Orders</th>
                        <th>SELL Preis</th>
                        <th>SELL Orders</th>
                        <th>History</th>
                    </tr>
                </thead>
                <tbody></tbody>
            `;
            const tbody = table.querySelector("tbody");

            for (const item in data[category]) {
                const orders = data[category][item];
                const buy = orders.find(o => o.orderSide === "BUY") || {};
                const sell = orders.find(o => o.orderSide === "SELL") || {};
                const tr = document.createElement("tr");
                tr.innerHTML = `
                    <td>${item}</td>
                    <td class="buy">${buy.price ?? "-"}</td>
                    <td>${buy.activeOrders ?? "-"}</td>
                    <td class="sell">${sell.price ?? "-"}</td>
                    <td>${sell.activeOrders ?? "-"}</td>
                    <td>
                        <button onclick="showHistory('${item}', this)">üìà</button>
                    </td>
                `;
                tbody.appendChild(tr);
            }
            content.appendChild(table);
        }
        status.textContent = "‚úÖ Marktdaten geladen";
    } catch (err) {
        console.error(err);
        status.textContent = "‚ùå Fehler beim Laden der Marktdaten";
    }
}

// AUKTIONEN
async function loadAuctions() {
    currentView = 'auctions';
    document.getElementById('sortButton').style.display = 'inline-block';
    const status = document.getElementById("status");
    const content = document.getElementById("content");
    status.textContent = "‚è≥ Lade Auktionen...";
    content.innerHTML = "";
    try {
        const response = await fetch("https://api.opsucht.net/auctions/active");
        const data = await response.json();
        auctionsData = data;
        displayAuctions();
        status.textContent = "‚úÖ Auktionen geladen";
    } catch (err) {
        console.error(err);
        status.textContent = "‚ùå Fehler beim Laden der Auktionen";
    }
}

async function displayAuctions() {
    const content = document.getElementById("content");
    content.innerHTML = "";

    const opItems = auctionsData.filter(a => a.item?.displayName);
    const normalItems = auctionsData.filter(a => !a.item?.displayName);

    function createTable(items, title) {
        if (!items.length) return;
        const h2 = document.createElement("h2"); h2.textContent = title; content.appendChild(h2);

        const table = document.createElement("table");
        table.innerHTML = `
            <thead>
                <tr>
                    <th>Item</th>
                    <th>Custom Name</th>
                    <th>Verk√§ufer</th>
                    <th>Startgebot</th>
                    <th>Aktuelles Gebot</th>
                    <th>Aktueller Bieter</th>
                    <th>Erstellt am</th>
                    <th>Endet am</th>
                </tr>
            </thead>
            <tbody></tbody>
        `;
        const tbody = table.querySelector("tbody");

        items.forEach(async auction => {
            const tr = document.createElement("tr");
            const techName = auction.item?.material ?? "-";
            const customName = auction.item?.displayName ?? "-";
            const sellerUuid = auction.seller;
            const currentBidderUuid = auction.highestBidder;
            const startBid = auction.startBid ?? "-";
            const currentBid = auction.currentBid ?? "-";

            const createdDate = new Date(auction.startTime);
            const createdStr = `${createdDate.getDate().toString().padStart(2,'0')}.${(createdDate.getMonth()+1).toString().padStart(2,'0')}.${createdDate.getFullYear()} ${createdDate.getHours().toString().padStart(2,'0')}:${createdDate.getMinutes().toString().padStart(2,'0')}:${createdDate.getSeconds().toString().padStart(2,'0')} Uhr`;

            const endDate = new Date(auction.endTime);
            const endStr = `${endDate.getDate().toString().padStart(2,'0')}.${(endDate.getMonth()+1).toString().padStart(2,'0')}.${endDate.getFullYear()} ${endDate.getHours().toString().padStart(2,'0')}:${endDate.getMinutes().toString().padStart(2,'0')}:${endDate.getSeconds().toString().padStart(2,'0')} Uhr`;

            tr.innerHTML = `
                <td>${techName}</td>
                <td>${customName}</td>
                <td class="seller">L√§dt...</td>
                <td class="buy">${startBid}</td>
                <td class="sell">${currentBid}</td>
                <td class="bidder">L√§dt...</td>
                <td>${createdStr}</td>
                <td>${endStr}</td>
            `;
            tbody.appendChild(tr);

            uuidToUsername(sellerUuid).then(name => tr.querySelector(".seller").textContent = name);
            uuidToUsername(currentBidderUuid).then(name => tr.querySelector(".bidder").textContent = name);
        });
        content.appendChild(table);
    }

    createTable(opItems, "OP-Items");
    createTable(normalItems, "Normale Items");
}

function toggleSort() {
    sortByEnd = !sortByEnd;
    document.getElementById("sortButton").textContent = sortByEnd ? "Sortieren nach: Bald endend" : "Sortieren nach: Neuste";
    if (sortByEnd) auctionsData.sort((a,b) => new Date(a.endTime) - new Date(b.endTime));
    else auctionsData.sort((a,b) => new Date(b.startTime) - new Date(a.startTime));
    displayAuctions();
}

// Erweiterte Suche: Techname + Custom Name
function filterItems() {
    const search = document.getElementById("searchInput").value.toLowerCase();
    document.querySelectorAll("table").forEach(table => {
        const rows = table.querySelectorAll("tbody tr");
        let visible = 0;
        rows.forEach(row => {
            const techName = row.children[0]?.textContent.toLowerCase() ?? "";
            const customName = row.children[1]?.textContent.toLowerCase() ?? "";
            const match = techName.includes(search) || customName.includes(search);
            row.style.display = match ? "" : "none";
            if (match) visible++;
        });
        const title = table.previousElementSibling;
        const show = visible > 0;
        table.style.display = show ? "table" : "none";
        if (title && title.tagName === "H2") title.style.display = show ? "block" : "none";
    });
}

// MARKT Diagramme
async function showHistory(itemName, btn) {
    const tr = btn.closest("tr");
    let chartRow = tr.nextElementSibling;
    if (chartRow && chartRow.classList.contains("chart-row")) {
        chartRow.remove();
        return;
    }
    const chartContainer = document.createElement("tr");
    chartContainer.classList.add("chart-row");
    chartContainer.innerHTML = `<td colspan="6">
        <div class="chart-buttons">
            <button onclick="updateHistoryChart('${itemName}','HOURLY')">Stunde</button>
            <button onclick="updateHistoryChart('${itemName}','DAILY')">Tag</button>
            <button onclick="updateHistoryChart('${itemName}','WEEKLY')">Woche</button>
            <button onclick="updateHistoryChart('${itemName}','MONTHLY')">Monat</button>
        </div>
        <canvas id="chart-${itemName}" class="chart-container"></canvas>
    </td>`;
    tr.parentNode.insertBefore(chartContainer, tr.nextSibling);
    await updateHistoryChart(itemName, 'DAILY');
}

async function updateHistoryChart(itemName, period) {
    try {
        const response = await fetch(`https://api.opsucht.net/market/history/${itemName}`);
        const data = await response.json();
        const history = data[period];
        const labels = history.map(h => {
            const d = new Date(h.timestamp);
            if (period === 'HOURLY') return d.getHours() + ':00';
            if (period === 'DAILY') return d.toLocaleDateString();
            if (period === 'WEEKLY') return 'KW' + Math.ceil((((d - new Date(d.getFullYear(),0,1))/86400000)+1)/7);
            if (period === 'MONTHLY') return (d.getMonth()+1) + '.' + d.getFullYear();
            return h.timestamp;
        });
        const prices = history.map(h => h.avgPrice);
        const ctx = document.getElementById(`chart-${itemName}`).getContext('2d');
        if (charts[itemName]) charts[itemName].destroy();
        charts[itemName] = new Chart(ctx, {
            type: 'line',
            data: { labels, datasets: [{ label: 'Avg Price', data: prices, borderColor: getComputedStyle(document.documentElement).getPropertyValue('--accent-color1'), backgroundColor: getComputedStyle(document.documentElement).getPropertyValue('--accent-color1')+'33', fill:true, tension:0.2 }] },
            options: { responsive:true, maintainAspectRatio:false, plugins:{legend:{display:false}}, animation:{duration:1000,easing:'easeOutQuart'}, scales:{y:{beginAtZero:false}} }
        });
    } catch(e) { console.error(e); alert('Fehler beim Laden der Preishistorie'); }
}
</script>

</body>
</html>
